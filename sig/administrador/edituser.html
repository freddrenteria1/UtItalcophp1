<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIG UT ITALCO - ADMINISTRADOR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        main{
            font-family: 'Arial Narrow', Arial, sans-serif;
        }
        .milink{
            cursor: pointer;
        }
    </style>

</head>
<body>
    <main>
        
            <div id="cab">
                <img src="img/header_1.jpg" style="width: 100%;" alt="">
            </div>
        <div class="container mt-3">
            
            <div class="row">
                <div class="col-sm-2 milink" onclick="inicio()">
                    <img src="img/inicio.png" height="60px" alt=""> <span style="font-size: large;"> Inicio</span>
                </div>
                
                <div class="col-sm-10 mt-2">
                    <h2>PLATAFORMA ADMINISTRATIVA - EDITAR USUARIO </h2>
                </div>
            </div>

           <hr>

            <div>

                <div class="row" style="width: 100%;">
                    

                    <div class="col-sm-4" style="text-align: right;">
                        Email
                    </div>
                    <div class="col-sm-8">
                        <input type="text" id="user" placeholder="Email" class="form-control">
                    </div>

                    <div class="col-sm-4" style="text-align: right;">
                        Clave
                    </div>
                    <div class="col-sm-8">
                        <input type="text" id="clave" placeholder="Clave" class="form-control">
                    </div>

                     

                    <div class="col-sm-4" style="text-align: right;">
                        Categorías
                    </div>
                    <div class="col-sm-7">
                        <select class="form-control" id="categorias">
                            
                        </select>
                    </div>

                    <div class="col-sm-1" style="text-align: right;">
                        <button type="button" class="btn btn-success" onclick="agregarAlm()">+</button>
                    </div>
                    <div class="col-sm-12">
                        <hr>
                        <h4>Categorías</h4>
                        <div class="container" id="listadoCat">
                        </div>
                        
                        <center>
                            <button type="button" class="btn btn-success" onclick="guardar()">Actualizar</button>
                        </center> <br><br>
                    </div>
                </div>
                
            </div>

        </div>
         
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        var url = 'https://utitalco.com/sig/server/';
        var user = sessionStorage.getItem('usersigadmin');
        var html = ''
        var texto = ''
        var arrayUsuarios = []
        var arrayCategorias = []
        var arrayCat = []
        var arrayCatSel = []
        var arrayCatSelId = []

        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        var id = getParameterByName('id');

        if(user == null){
            location = 'login.html'
        }

        function inicio(){
            location = 'index.html';
        }

        function buscar(){
            location = 'busqueda.html';
        }

        cargar_cat();

        function cargar_cat(){
            $.post(url+'cargarCats.php',{},
            function(resp){
                arrayCat = resp
                texto = ''
                html = '<option value="">Seleccione Categoría...</option>'
                for(var i=0; i<arrayCat.length; i++){
                    html += `
                        <option value="${[i]}">${arrayCat[i].categoria}</option>
                    `
                }
                $('#categorias').html(html)
                cargarUsuario()
            })
        }

        function cargarUsuario(){
            $.post(url+'cargarUser.php',{id:id},
            function(resp){
                $('#user').val(resp.user)
                $('#clave').val(resp.clave)

                arrayUsuarios = resp

                if(arrayUsuarios.categorias != 'null'){
                    arrayCatSel = JSON.parse(resp.categorias)
                    arrayCatSelId = JSON.parse(resp.catid)
                    console.log('Categorias null')
                }else{
                    console.log('Categorias existentes')
                }

                mostrarPermisos()
            })
        }


        function mostrarPermisos() {
            if(arrayCatSel != null){
                var html = ''
                for (var i = 0; i < arrayCatSel.length; i++) {
                    html += `
                         <button type="button" class="btn btn-warning btn-sm">${arrayCatSel[i].categoria}</button>
                         <button type="button" class="btn btn-danger btn-sm" onclick="quitarAlm('${i}')">X</button> <hr>
                    `
                }
                $('#listadoCat').html(html)

            }
        }

        function quitarAlm(i) {
            arrayCatSel.splice(i, 1);
            arrayCatSelId.splice(i, 1);
            mostrarPermisos()
        }

        function agregarAlm() {
            var id = $('#categorias').val()
           // var id = parseInt(id)-1;

            

            arrayCatSel.push({
                'id': arrayCat[id].idcat,
                'categoria': arrayCat[id].categoria
            })

            arrayCatSelId.push({
                'categoria': arrayCat[id].idcat
            })

            mostrarPermisos()

        }

        function guardar() {
            var user = $('#user').val()
            var clave = $('#clave').val()
            var catSel = JSON.stringify(arrayCatSelId)

            $.post(url + 'actUsuario.php', {
                    id: id,
                    user: user,
                    clave: clave,
                    catSel: catSel,
                },
                function(resp) {
                    if (resp.msn == 'Ok') {
                        Swal.fire({
                            position: 'top-end',
                            icon: 'success',
                            title: 'Actualizar...',
                            text: 'Usuario actualizado...!',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {

                            location = 'usuarios.html'
                        })
                    } else {
                        console.log(resp.msn)
                        Swal.fire({
                            position: 'top-end',
                            icon: 'error',
                            title: 'Oops...',
                            text: resp.msn,
                            showConfirmButton: false,
                            timer: 1500
                        })
                    }
                })
        }
    


    </script>
</body>
</html>