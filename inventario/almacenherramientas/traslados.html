<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almacén Consumibles - Inventario UT Italco</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/42edaf6504.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">

    <!-- <link rel="stylesheet" href="css/chosen.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ==" crossorigin="anonymous" referrerpolicy="no-referrer">


    <style>
        body {
            background-image: url('img/fondo_1.jpg');
            background-size: cover;
            background-position: fixed;
            font-family: 'PT Sans', sans-serif;
        }
        
        .cabecera {
            padding-top: 20px;
            opacity: 1;
        }
        
        .micard {
            border-radius: 15px;
            box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
            cursor: pointer;
        }
        
        .micard:hover {
            box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
        }
        
        .tit {
            padding: 8px;
            text-align: center;
        }
        
        .cuerpo {
            background-color: aliceblue;
            padding: 15px;
            border-radius: 5px;
            font-size: 20px;
            margin: 10px;
        }
        
        input[type=text] {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            font-size: 20px;
        }
        
        .miselect {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            font-size: 20px;
        }
        
        input[type=number] {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            font-size: 20px;
        }
        
        .mibtn {
            width: 100%;
            margin: 8px 0;
            box-sizing: border-box;
            font-size: 30px;
        }
    </style>
</head>

<body>


    <main>
        <header>
            <div class="px-3 py-2 bg-dark text-white">
                <div class="container">
                    <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                        <a href="/" class="d-flex align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none">
                            <img src="img/system_stock_n.png" width="200px" alt="">

                        </a>

                        <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small">
                            <li>
                                <a href="./" class="nav-link text-white">
                                    Inicio
                                </a>
                            </li>
                            <li>
                                <a href="entrada.html" class="nav-link text-white">
                                    Entradas
                                </a>
                            </li>
                            <li>
                                <a href="salida.html" class="nav-link text-secondary">
                                    Remisión Salida
                                </a>
                            </li>
                            <li>
                                <a href="inventario.html" class="nav-link text-white">
                                    Inventario
                                </a>
                            </li>
                            <li>
                                <a href="login.html" class="nav-link text-white">
                                    Salir
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </header>

        <div class="container mt-3">

            <div class="m-3">
                <h3 class="tit">Almacén Herramientas ODS <span id="numods"></span> </h3>
            </div>
            <hr>

            <h3>Traslado de almacén | # <input type="text" style="width: 100px; color: red; font-weight: bold;" id="numentrada" readonly> |
                <label for="">Fecha</label>
                <input type="text" id="fecha" style="width: 120px;" readonly>
                <button type="button" class="btn btn-info" style="float: right; padding: 10px; margin: 5px;" onclick="rep()">Ver Traslados Entrantes</button>
                <button type="button" class="btn btn-danger" style="float: right; padding: 10px; margin: 5px;" onclick="repsal()">Ver Traslados Salientes</button>
            </h3>
            <hr>
            <div class="cuerpo">
                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-6">
                            <label for="">Almacen</label>
                            <input type="text" id="almacen" value="Herramientas" readonly>
                        </div>
                        <div class="col-sm-2">
                            <label for="">ODS</label>
                            <select id="ods" class="form-control miselect" onchange="buscarUbica()">
                                <option value="">Seleccione...</option>
                                <option value="LOGISTICA CENTRAL">LOGISTICA CENTRAL</option>
                                <option value="ADMINISTRACIÓN">ADMINISTRACIÓN</option>
                                <option value="021">021</option>
                                <option value="022">022</option>
                                <option value="023">023</option>
                                <option value="024">024</option>
                                <option value="025">025</option>
                                <option value="026">026</option>
                                <option value="027">027</option>
                                <option value="028">028</option>
                                <option value="029">029</option>
                                <option value="030">030</option>
                                <option value="031">031</option>
                                <option value="032">032</option>
                                <option value="033">033</option>
                                <option value="034">034</option>
                                <option value="035">035</option>
                                 
                            </select>
                        </div>
                        <div class="col-sm-4">
                            <label for="">Ubicación Destino</label>
                            <select id="ubicacion" class="form-control miselect">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cuerpo">
                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-2" style="width: 140px;">
                            <label for="">CANT</label>
                            <input type="number" class="form-control" id="cant" value="1" style="width: 120px;">
                        </div>
                        <div class="col-sm-2">
                            <label for="">CÓDIGO</label>
                            <input type="number" class="form-control" id="codigo" placeholder="Código" onchange="buscarCodItem()">
                        </div>
                        <div class="col-sm-8">
                            <label for="">ARTÍCULO</label>
                            <input type="text" class="form-control" id="item" placeholder="Artículo">
                        </div>
                        <div class="col-sm-11">
                            <label for="">DETALLES</label>
                            <input type="text" class="form-control" id="detalles" placeholder="Detalles" onchange="agregar()">
                        </div>
                        <div class="col-sm-1">
                            <label for="">.</label><br>
                            <button type="button" class="btn btn-success mibtn" onclick="agregar()">+</button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="cuerpo">
                <table class="table">
                    <thead>
                        <th>#</th>
                        <th>CANT</th>
                        <th>CÓDIGO</th>
                        <th>UNIDAD</th>
                        <th>ARTÍCULO</th>
                        <th></th>
                    </thead>
                    <tbody id="tablaDatos">

                    </tbody>

                </table>
                <hr>
                <textarea id="observaciones" class="form-control" cols="30" rows="3" placeholder="Observaciones" onkeyup="mayus(this);"></textarea>
                <hr>
                <button type="button" class="btn btn-success" onclick="guardar()">Guardar</button>
                <button type="button" class="btn btn-danger">Cancelar</button>
            </div>

        </div>


    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- <script src="js/chosen.jquery.js" type="text/javascript"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>

    <script>
        var odsalm = sessionStorage.getItem('odsalm')
        var almacen = sessionStorage.getItem('almacen')
        var useralm = sessionStorage.getItem('useralm')
        var ubicacion = sessionStorage.getItem('ubicaherr')


        if (useralm == null || useralm == "") {
            location = 'login.html';
        }

        $('#numods').html(odsalm + ' ' + ubicacion)

        var arrayItems = []
        var arrayItem = []
        var arrayItemSel = []
        var arrayCod = []

        var url = 'https://utitalco.com/inventario/server/'

        const hoy = new Date();

        function formatoFecha(fecha, formato) {
            const map = {
                dd: fecha.getDate(),
                mm: fecha.getMonth() + 1,
                yy: fecha.getFullYear().toString().slice(-2),
                yyyy: fecha.getFullYear()
            }

            return formato.replace(/dd|mm|yy|yyy/gi, matched => map[matched])
        }

        var fechahoy = formatoFecha(hoy, 'dd/mm/yy');

        $('#fecha').val(fechahoy)

        contarRegistros()
        cargarItems()

        function contarRegistros() {
            $.post(url + 'contarRegTr.php',
                function(resp) {
                    $('#numentrada').val(resp.num + 1)
                })
        }

        function cargarItems() {
            $.post(url + 'cargarItemsHerra.php', {
                    ods: odsalm,
                    ubicacion: ubicacion
                },
                function(resp) {
                    arrayItems = resp

                    for (var i = 0; i < arrayItems.length; i++) {
                        arrayItem.push(arrayItems[i].codigo + '|' + arrayItems[i].unidad + '|' + arrayItems[i].item)
                        arrayCod.push(arrayItems[i].codigo)
                    }

                    var availableTags = arrayItem;
                    $("#item").autocomplete({
                        source: availableTags
                    });

                    var availableTags2 = arrayCod;
                    $("#codigo").autocomplete({
                        source: availableTags2
                    });

                })
        }

        function agregar() {
            var itemsel = $('#item').val()
            var cant = $('#cant').val()
            var det = $('#detalles').val()

            if (cant <= 0) {
                Swal.fire({
                    position: 'top-end',
                    icon: 'info',
                    title: 'Cantidad de item debe ser mayor a cero',
                    showConfirmButton: false,
                    timer: 3000
                })
            } else {
                //VERIFICA EXISTENCIAS ANTES DE CONTINUAL
                var partes = itemsel.split('|');
                var cod = partes[0]
                var unid = partes[1]
                var itemp = partes[2]

                $.post(url + 'verificarExistencias.php', {
                        codigo: cod,
                        cant: cant,
                        alm: 'AH' + odsalm + ubicacion
                    },
                    function(resp) {
                        if (resp.msn == 'Ok') {


                            var index = null

                            for (var i = 0, len = arrayItemSel.length; i < len; i++) {
                                if (arrayItemSel[i].cod === cod) {
                                    index = i;
                                    break;
                                }
                            }

                            if (index != null) {
                                // Swal.fire({
                                //     position: 'top-end',
                                //     icon: 'info',
                                //     title: 'Item ya está registrado...',
                                //     showConfirmButton: false,
                                //     timer: 3000
                                // })
                            } else {
                                if (partes.length == 1) {
                                    Swal.fire({
                                        position: 'top-end',
                                        icon: 'info',
                                        title: 'Debe seleccionar un item del listado',
                                        showConfirmButton: false,
                                        timer: 3000
                                    })
                                } else {
                                    arrayItemSel.push({
                                        'cant': cant,
                                        'cod': cod,
                                        'unidad': unid,
                                        'item': itemp,
                                        'detalles': det
                                    })
                                }



                                $('#cant').val('1')
                                $('#item').val('')
                                $('#det').val('')

                                cargarSeleccionados()
                            }
                        } else {
                            Swal.fire({
                                position: 'top-end',
                                icon: 'info',
                                title: resp.msn,
                                showConfirmButton: false,
                                timer: 3000
                            })
                        }
                    })

            }




        }

        function cargarSeleccionados() {
            var html = ''
            for (var i = 0; i < arrayItemSel.length; i++) {
                html += `
                <tr>
                    <td>${i+1}</td>
                    <td>
                        <input type="number" style="width: 80px; padding: 2px 2px; margin: 0px 0; box-sizing: border-box; font-size: 20px;" id="cantitem"  
                        value="${arrayItemSel[i].cant}" onchange="cambiarCant('${arrayItemSel[i].cod}', this)">
                    </td>
                    <td>${arrayItemSel[i].cod}</td>
                    <td>${arrayItemSel[i].unidad}</td>
                    <td>${arrayItemSel[i].item} - ${arrayItemSel[i].detalles}</td>
                    <td><button type="button" class="btn btn-danger" onclick="borrarItem('${arrayItemSel[i].cod}')">X</button></td>
                </tr>
                `
            }
            $('#tablaDatos').html(html)
        }

        function borrarItem(coditem) {
            for (var i = 0, len = arrayItemSel.length; i < len; i++) {
                if (arrayItemSel[i].cod === coditem) {
                    index = i;
                    break;
                }
            }

            if (index !== -1) {
                arrayItemSel.splice(index, 1);
            }
            cargarSeleccionados()
        }

        function cambiarCant(coditem, e) {
            var canti = e.value
            $.post(url + 'verificarExistencias.php', {
                    codigo: coditem,
                    cant: canti,
                    alm: 'AH' + odsalm + ubicacion
                },
                function(resp) {
                    if (resp.msn == 'Ok') {

                        if (e.value > 0) {
                            for (var i = 0, len = arrayItemSel.length; i < len; i++) {
                                if (arrayItemSel[i].cod === coditem) {

                                    arrayItemSel[i].cant = canti
                                    break;
                                }
                            }
                        }

                        cargarSeleccionados()

                    } else {
                        Swal.fire({
                            position: 'top-end',
                            icon: 'info',
                            title: resp.msn,
                            showConfirmButton: false,
                            timer: 3000
                        })
                    }
                })
        }

        function sumarItem(coditem) {
            for (var i = 0, len = arrayItemSel.length; i < len; i++) {
                if (arrayItemSel[i].cod === coditem) {
                    var canti = arrayItemSel[i].cant
                    canti++
                    arrayItemSel[i].cant = canti
                    break;
                }
            }

            cargarSeleccionados()
        }

        function restarItem(coditem) {
            for (var i = 0, len = arrayItemSel.length; i < len; i++) {
                if (arrayItemSel[i].cod === coditem) {
                    var canti = arrayItemSel[i].cant
                    canti--
                    if (canti < 1) {
                        canti = 1
                    }
                    arrayItemSel[i].cant = canti
                    break;
                }
            }

            cargarSeleccionados()
        }

        function cargando() {
            let timerInterval
            Swal.fire({
                title: 'Guardando!',
                html: 'Un momento por favor...',
                timer: 35000,
                timerProgressBar: true,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                    timerInterval = setInterval(() => {

                    }, 1000)
                },
                willClose: () => {
                    clearInterval(timerInterval)
                }
            }).then((result) => {
                /* Read more about handling dismissals below */
                if (result.dismiss === Swal.DismissReason.timer) {

                }
            })
        }

        function guardar() {

            if (arrayItemSel.length == 0) {
                Swal.fire({
                    position: 'top-end',
                    icon: 'info',
                    title: 'Debe agregar items',
                    showConfirmButton: false,
                    timer: 3000
                })
            } else {
                if ($('#observaciones').val() != '' && $('#ods').val() != '' && $('#ubicacion').val()) {
                    Swal.fire({
                        title: 'Desea guardar el Trasaldo?',
                        text: 'Se actualizará el inventario',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, Guardar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        allowOutsideClick: false
                    }).then((result) => {
                        /* Read more about isConfirmed, isDenied below */
                        if (result.isConfirmed) {

                            cargando()

                            var odsdest = $('#ods').val()
                            var ubicadest = $('#ubicacion').val()
                            var itemsEntrada = JSON.stringify(arrayItemSel)
                            var observaciones = $('#observaciones').val()

                            var formData = new FormData();

                            formData.append('odsdest', odsdest);
                            formData.append('ubicadest', ubicadest);
                            formData.append('ods', odsalm);
                            formData.append('ubicacion', ubicacion);
                            formData.append('items', itemsEntrada);
                            formData.append('observaciones', observaciones);
                            formData.append('user', useralm)

                            $.ajax({
                                url: url + 'guardarSalidaTrasHerr.php',
                                type: 'post',
                                data: formData,
                                contentType: false,
                                processData: false,
                                success: function(response) {
                                    Swal.fire({
                                        position: 'top-end',
                                        icon: 'success',
                                        title: 'Registrada correctamente...',
                                        showConfirmButton: true
                                    }).then(() => {
                                        location = 'trasladosimp.html?id=' + response.id
                                            // location.reload()
                                    })
                                }
                            })


                        }
                    })
                } else {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'info',
                        title: 'Debe agregar una observación...',
                        showConfirmButton: false,
                        timer: 3000
                    })
                }

            }

        }

        function buscarCodItem() {
            var codsel = $('#codigo').val()

            //busca el item
            $.post(url + 'buscarItemSel.php', {
                    cod: codsel
                },
                function(resp) {
                    var html = resp.codigo + '|' + resp.unidad + '|' + resp.item
                    $('#item').val(html)
                    $('#codigo').val('')
                    $('#detalles').setfocus()
                        //agregar()
                })
        }

        function mayus(e) {
            e.value = e.value.toUpperCase();
        }

        function buscarCed(ced) {
            $.post(url + 'buscarCed.php', {
                    ced: ced.value
                },
                function(resp) {
                    arrayDatosTrab = resp
                    $('#nombres').val(arrayDatosTrab.nombres)
                })
        }

        function buscarUbica() {
            var odssel = $('#ods').val()
                //buscar ubicaciones de la ods
            $.post(url + 'buscarUbica.php', {
                    ods: odssel,
                    alm: 'Herramientas'
                },
                function(resp) {
                    if (resp != null) {
                        arrayUbica = resp
                        var html = ''
                        for (var i = 0; i < arrayUbica.length; i++) {
                            html += `
                            <option value="${arrayUbica[i].ubicacion}">${arrayUbica[i].ubicacion}</option>
                            `
                        }
                        $('#ubicacion').html(html)

                    } else {
                        Swal.fire({
                            position: 'top-end',
                            icon: 'info',
                            title: 'Orden de Servicio sin almacen de herramientas registrado...',
                            showConfirmButton: false,
                            timer: 3000
                        })
                    }
                })
        }


        function rep() {
            location = 'reptrasladosent.html'
        }

        function repsal() {
            location = 'reptrasladossal.html'
        }
    </script>
</body>

</html>